-- =================================================================
-- SkillSwap DATABASE SCHEMA
-- Version: 1.0
-- Description: A complete, clean schema for the SkillSwap project.
-- =================================================================

-- ========= SECTION 1: CLEANUP =========
-- Drop existing objects to ensure a clean slate.
-- Note: Dropping in reverse order of dependency.
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user;
DROP TABLE IF EXISTS public.messages, public.reviews, public.sessions, public.deals, public.services, public.user_settings, public.profiles CASCADE;
DROP TYPE IF EXISTS public.deal_status, public.user_role, public.verification_status, public.visibility_level;


-- ========= SECTION 2: CUSTOM TYPES (ENUMs) =========
CREATE TYPE public.deal_status AS ENUM (
  'NEGOTIATING',
  'AWAITING_PAYMENT',
  'IN_PROGRESS',
  'DELIVERED',
  'COMPLETED',
  'DISPUTED',
  'CANCELED'
);

CREATE TYPE public.verification_status AS ENUM ('UNVERIFIED', 'PENDING', 'VERIFIED', 'REJECTED');
CREATE TYPE public.visibility_level AS ENUM ('PUBLIC', 'PRIVATE', 'CONNECTIONS_ONLY');


-- ========= SECTION 3: TABLES =========

-- Profiles Table: Stores public user data.
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  -- Core Info (Nullable on signup)
  name TEXT,
  student_id TEXT UNIQUE,
  -- Contact Info
  email TEXT, -- This is the user's primary contact email from OAuth
  phone TEXT,
  -- Academic Info
  major TEXT,
  campus TEXT,
  -- Contributor-specific fields (can be NULL)
  bio TEXT,
  skills TEXT[],
  portfolio_url TEXT,
  verification_status public.verification_status NOT NULL DEFAULT 'UNVERIFIED',
  ktm_image_url TEXT,
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.profiles IS 'Stores all public-facing user information and contributor-specific details.';

-- User Settings Table: Stores private user preferences.
CREATE TABLE public.user_settings (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email_notifications_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  profile_visibility public.visibility_level NOT NULL DEFAULT 'PUBLIC',
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.user_settings IS 'Stores user-specific private settings and preferences.';

-- Services Table: Listings created by Contributors.
CREATE TABLE public.services (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  seller_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  price NUMERIC NOT NULL CHECK (price >= 0),
  category TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.services IS 'Service listings offered by verified contributors.';

-- Deals Table: Represents a transaction between a buyer and a seller.
CREATE TABLE public.deals (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  service_id BIGINT NOT NULL REFERENCES public.services(id),
  buyer_id UUID NOT NULL REFERENCES public.profiles(id),
  seller_id UUID NOT NULL REFERENCES public.profiles(id),
  final_amount NUMERIC NOT NULL CHECK (final_amount >= 0),
  status public.deal_status NOT NULL DEFAULT 'NEGOTIATING',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.deals IS 'Represents a single transaction or agreement between a buyer and a seller.';

-- Reviews Table: For two-way feedback after a deal is completed.
CREATE TABLE public.reviews (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  deal_id BIGINT NOT NULL REFERENCES public.deals(id) ON DELETE CASCADE,
  reviewer_id UUID NOT NULL REFERENCES public.profiles(id),
  reviewee_id UUID NOT NULL REFERENCES public.profiles(id),
  rating SMALLINT NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(deal_id, reviewer_id) -- Ensures a user can only review a deal once.
);
COMMENT ON TABLE public.reviews IS 'Stores feedback and ratings for both parties after a deal is completed.';

-- Messages Table: For chat functionality within a deal.
CREATE TABLE public.messages (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  deal_id BIGINT NOT NULL REFERENCES public.deals(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES public.profiles(id),
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.messages IS 'Stores chat messages related to a specific deal.';

-- Sessions Table: For scheduled meetings related to a deal.
CREATE TABLE public.sessions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  deal_id BIGINT NOT NULL REFERENCES public.deals(id) ON DELETE CASCADE,
  session_datetime TIMESTAMPTZ NOT NULL,
  meeting_link TEXT,
  is_completed BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.sessions IS 'Scheduled meeting times for a deal.';


-- ========= SECTION 4: TRIGGERS & FUNCTIONS =========

-- Auto-create profile and settings on new user signup.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Create a profile
  INSERT INTO public.profiles (id, email)
  VALUES (NEW.id, NEW.email);
  -- Create user settings
  INSERT INTO public.user_settings (user_id)
  VALUES (NEW.id);
  RETURN NEW;
END;
$$;

-- Link the function to the auth.users table.
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

COMMENT ON FUNCTION public.handle_new_user() IS 'Triggered on new user creation to automatically provision a profile and settings.';


-- ========= SECTION 5: ROW LEVEL SECURITY (RLS) =========

-- Enable RLS on all tables
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.services ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.deals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sessions ENABLE ROW LEVEL SECURITY;

-- --- Profiles Policies ---
-- 1. Anyone can view public profiles.
CREATE POLICY "Profiles are publicly viewable." ON public.profiles FOR SELECT USING (true);
-- 2. Users can update their own profile.
CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id) WITH CHECK (auth.uid() = id);
-- NOTE: No INSERT policy for users. Handled by trigger. No DELETE policy for now to prevent accidental deletion.

-- --- User Settings Policies ---
-- 1. Users can only view and edit their own settings.
CREATE POLICY "Users can manage their own settings." ON public.user_settings FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
-- NOTE: No INSERT policy for users. Handled by trigger.

-- --- Services Policies ---
-- 1. Anyone can view active services.
CREATE POLICY "Active services are publicly viewable." ON public.services FOR SELECT USING (is_active = true);
-- 2. Verified users can create services.
CREATE POLICY "Verified contributors can create services." ON public.services FOR INSERT WITH CHECK (
  auth.uid() = seller_id AND
  (SELECT verification_status FROM public.profiles WHERE id = auth.uid()) = 'VERIFIED'
);
-- 3. Sellers can update their own services.
CREATE POLICY "Sellers can update their own services." ON public.services FOR UPDATE USING (auth.uid() = seller_id) WITH CHECK (auth.uid() = seller_id);
-- 4. Sellers can delete their own services.
CREATE POLICY "Sellers can delete their own services." ON public.services FOR DELETE USING (auth.uid() = seller_id);

-- --- Deals, Reviews, Messages, Sessions Policies (Participant-based access) ---
-- 1. Users can only view deals they are part of (buyer or seller).
CREATE POLICY "Participants can view their own deals." ON public.deals FOR SELECT USING (auth.uid() = buyer_id OR auth.uid() = seller_id);
-- 2. Users can only update deals they are part of.
CREATE POLICY "Participants can update their own deals." ON public.deals FOR UPDATE USING (auth.uid() = buyer_id OR auth.uid() = seller_id) WITH CHECK (auth.uid() = buyer_id OR auth.uid() = seller_id);
-- 3. Buyers can initiate deals.
CREATE POLICY "Buyers can create deals." ON public.deals FOR INSERT WITH CHECK (auth.uid() = buyer_id);

-- 4. Participants of a deal can see reviews, messages, and sessions for that deal.
CREATE POLICY "Participants can view their deal's reviews." ON public.reviews FOR SELECT USING (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid())))
);
CREATE POLICY "Participants can view their deal's messages." ON public.messages FOR SELECT USING (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid())))
);
CREATE POLICY "Participants can view their deal's sessions." ON public.sessions FOR SELECT USING (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid())))
);

-- 5. Users can only create reviews, messages, sessions for deals they are part of.
CREATE POLICY "Participants can create reviews for their deal." ON public.reviews FOR INSERT WITH CHECK (reviewer_id = auth.uid() AND (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid()))))
);
CREATE POLICY "Participants can send messages in their deal." ON public.messages FOR INSERT WITH CHECK (sender_id = auth.uid() AND (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid()))))
);
CREATE POLICY "Participants can create sessions for their deal." ON public.sessions FOR INSERT WITH CHECK (
  (SELECT EXISTS (SELECT 1 FROM deals WHERE id = deal_id AND (buyer_id = auth.uid() OR seller_id = auth.uid())))
);


-- ========= SECTION 6: STORAGE =========
-- Note: This assumes the bucket does not exist. If it does, this will do nothing.
INSERT INTO storage.buckets (id, name, public)
VALUES ('ktm_images', 'ktm_images', false)
ON CONFLICT (id) DO NOTHING;

-- Policies for storage are managed separately and assumed to be correct from previous context.
-- It's generally better to manage storage RLS from the Supabase dashboard UI if complex.

-- =================================================================
-- END OF SCHEMA
-- =================================================================
